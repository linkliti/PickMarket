import logging

from bs4 import BeautifulSoup
from seleniumbase import Driver
from seleniumbase import undetected

log = logging.getLogger(__name__)


def get_categories(driver: undetected.Chrome, url: str, selector: str) -> list:
  """TODO"""
  log.debug("getting categories from: %s", url)
  driver.default_get(url)
  html = driver.page_source
  print(html)
  while "Please, enable JavaScript to continue" in html:
    log.debug("anti-bot triggered, refreshing...")
    driver.get(url)
    html = driver.page_source
  soup = BeautifulSoup(html, "html.parser")
  categories = soup.select(selector)
  subcategories = []
  for category in categories:
    subcategories += get_categories(
      driver=driver,
      url="https://www.ozon.ru" + category["href"],
      selector='[data-widget="filtersDesktop"] div[style="margin-left:16px;"] a[href*="/category"]',
    )
  return [[category.text, "https://www.ozon.ru" + category["href"]]
          for category in categories + subcategories]


def server() -> None:
  # chrome
  driver: undetected.Chrome = Driver(uc=True,
                                     headless=False,
                                     mobile=False,
                                     cap_file="./capabilities.py")
  # driver.get("https://www.ozon.ru")
  log.debug("chrome started")
  try:
    print(get_categories(driver, "https://www.ozon.ru/category/", 'a[href*="/category"]'))
    driver.sleep(10)
  finally:
    driver.quit()
